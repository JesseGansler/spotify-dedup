!function(e){var t={};function n(r){if(t[r])return t[r].exports;var s=t[r]={i:r,l:!1,exports:{}};return e[r].call(s.exports,s,s.exports,n),s.l=!0,s.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var s in e)n.d(r,s,function(t){return e[t]}.bind(null,s));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=16)}([function(e,t,n){"use strict";const r="localhost:8005"===location.host?"http://localhost:8005/callback.html":"https://jmperezperez.com/spotify-dedup/callback.html",s=/http[s]?:\/\/[^/]+/.exec(r)[0];t.a={clientId:"04dca0de1c4e4aca88cc615ac23581be",redirectUri:r,host:s}},function(e,t,n){"use strict";const r=2e3,s=[];let o=!1;async function i(){if(!o&&s.length>0){o=!0;const e=s.shift();!async function e({promise:t,resolve:n,reject:s,url:o,options:i,retries:a}){console.log("execute");try{let c=await fetch(o,i),l=c.status<400;l||console.log("got status "+c.status+" with retries "+a,o,i),l?n(c):--a>0?setTimeout(()=>{e({promise:t,resolve:n,reject:s,url:o,options:i,retries:a})},r+5e3*Math.random()):s(c)}catch(l){--a>0?setTimeout(()=>{e({promise:t,resolve:n,reject:s,url:o,options:i,retries:a})},r+2e3*Math.random()):s(c)}}({promise:e.promise,resolve:e.resolve,reject:e.reject,url:e.url,options:e.options,retries:e.retries})}}t.a=async function(e,t){console.log("customFetch",{url:e,options:t});const n=new Promise((n,r)=>{s.push({promise:null,resolve:n,reject:r,url:e,options:t,retries:3})});return i(),n.then(e=>{o=!1,i()}),n}},function(e,t,n){"use strict";n(1);async function r(e,t,n){async function r(e,t,r){return n.getGeneric(`${function(e){return-1!==e.indexOf("?")?e.substr(0,e.indexOf("?")):e}(e.href)}?offset=${t}&limit=${r}`)}const s=await e;if(null===s)return[];const o=[()=>e];let i=s.limit+s.offset;const a=s.limit;for(;s.total>i;)!function(e,t,n){console.log(t,n);o.push(()=>r(e,t,n))}(s,i,a),i+=a;return o.reduce((e,t)=>e.then(e=>t().then(Array.prototype.concat.bind(e))),Promise.resolve([]))}n.d(t,"a",function(){return o}),n.d(t,"b",function(){return i});class s{constructor(e,t){this.api=e,this.promiseThrottle=t}async removeDuplicates(e){throw"Not implemented"}async getTracks(){throw"Not implemented"}findDuplicatedTracks(e){const t={},n={};return e.reduce((e,r,s)=>{if(null===r)return e;if(null===r.id)return e;let o=!1;const i=`${r.name}:${r.artists[0].name}`;return r.id in t?o=!0:i in n&&Math.abs(n[i]-r.duration_ms)<2e3&&(o=!0),o?e.push({index:s,track:r,reason:r.id in t?"same-id":"same-name-artist"}):(t[r.id]=!0,n[i]=r.duration_ms),e},[])}}class o extends s{constructor(e,t){super(e,t)}async getTracks(e){return new Promise((t,n)=>{const s=[];r(this.api.getGeneric(e.tracks.href),this.promiseThrottle,this.api).then(e=>Promise.all(e)).then(e=>{e.forEach(e=>{e.items.forEach((e,t)=>{s.push(e.track)})}),t(s)}).catch(n)})}async removeDuplicates(e){return new Promise((t,n)=>{if("starred"===e.playlist.id&&n("It is not possible to delete duplicates from your Starred playlist using this tool since this is not supported in the Spotify Web API. You will need to remove these manually."),e.playlist.collaborative)n("It is not possible to delete duplicates from a collaborative playlist using this tool since this is not supported in the Spotify Web API. You will need to remove these manually.");else{const r=e.duplicates.map(e=>({uri:e.track.linked_from?e.track.linked_from.uri:e.track.uri,positions:[e.index]})).reverse(),s=[];do{const t=r.splice(0,100);!function(e,t,n){s.push(()=>n.removeTracksFromPlaylist(e.playlist.owner.id,e.playlist.id,t))}(e,t,this.api)}while(r.length>0);s.reduce((e,t)=>e.then(()=>t()),Promise.resolve(null)).then(()=>{e.duplicates.duplicates=[],t()}).catch(e=>{n(e)})}})}}class i extends s{constructor(e,t){super(e,t)}async getTracks(e){return new Promise((t,n)=>{const s=[];r(e,this.promiseThrottle,this.api).then(e=>Promise.all(e)).then(e=>{e.forEach(e=>{e.items.forEach((e,t)=>{s.push(e.track)})}),t(s)}).catch(n)})}async removeDuplicates(e){return new Promise((t,n)=>{const r=e.duplicates.map(e=>e.track.linked_from?e.track.linked_from.id:e.track.id);do{(async()=>{const e=r.splice(0,50);await this.api.removeFromMySavedTracks(e)})()}while(r.length>0);e.duplicates=[],t()})}}},function(e,t,n){var r={},s=function(e){var t;return function(){return void 0===t&&(t=e.apply(this,arguments)),t}}(function(){return window&&document&&document.all&&!window.atob}),o=function(e){var t={};return function(e){if("function"==typeof e)return e();if(void 0===t[e]){var n=function(e){return document.querySelector(e)}.call(this,e);if(window.HTMLIFrameElement&&n instanceof window.HTMLIFrameElement)try{n=n.contentDocument.head}catch(e){n=null}t[e]=n}return t[e]}}(),i=null,a=0,c=[],l=n(10);function u(e,t){for(var n=0;n<e.length;n++){var s=e[n],o=r[s.id];if(o){o.refs++;for(var i=0;i<o.parts.length;i++)o.parts[i](s.parts[i]);for(;i<s.parts.length;i++)o.parts.push(y(s.parts[i],t))}else{var a=[];for(i=0;i<s.parts.length;i++)a.push(y(s.parts[i],t));r[s.id]={id:s.id,refs:1,parts:a}}}}function p(e,t){for(var n=[],r={},s=0;s<e.length;s++){var o=e[s],i=t.base?o[0]+t.base:o[0],a={css:o[1],media:o[2],sourceMap:o[3]};r[i]?r[i].parts.push(a):n.push(r[i]={id:i,parts:[a]})}return n}function d(e,t){var n=o(e.insertInto);if(!n)throw new Error("Couldn't find a style target. This probably means that the value for the 'insertInto' parameter is invalid.");var r=c[c.length-1];if("top"===e.insertAt)r?r.nextSibling?n.insertBefore(t,r.nextSibling):n.appendChild(t):n.insertBefore(t,n.firstChild),c.push(t);else if("bottom"===e.insertAt)n.appendChild(t);else{if("object"!=typeof e.insertAt||!e.insertAt.before)throw new Error("[Style Loader]\n\n Invalid value for parameter 'insertAt' ('options.insertAt') found.\n Must be 'top', 'bottom', or Object.\n (https://github.com/webpack-contrib/style-loader#insertat)\n");var s=o(e.insertInto+" "+e.insertAt.before);n.insertBefore(t,s)}}function f(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e);var t=c.indexOf(e);t>=0&&c.splice(t,1)}function h(e){var t=document.createElement("style");return void 0===e.attrs.type&&(e.attrs.type="text/css"),m(t,e.attrs),d(e,t),t}function m(e,t){Object.keys(t).forEach(function(n){e.setAttribute(n,t[n])})}function y(e,t){var n,r,s,o;if(t.transform&&e.css){if(!(o=t.transform(e.css)))return function(){};e.css=o}if(t.singleton){var c=a++;n=i||(i=h(t)),r=g.bind(null,n,c,!1),s=g.bind(null,n,c,!0)}else e.sourceMap&&"function"==typeof URL&&"function"==typeof URL.createObjectURL&&"function"==typeof URL.revokeObjectURL&&"function"==typeof Blob&&"function"==typeof btoa?(n=function(e){var t=document.createElement("link");return void 0===e.attrs.type&&(e.attrs.type="text/css"),e.attrs.rel="stylesheet",m(t,e.attrs),d(e,t),t}(t),r=function(e,t,n){var r=n.css,s=n.sourceMap,o=void 0===t.convertToAbsoluteUrls&&s;(t.convertToAbsoluteUrls||o)&&(r=l(r));s&&(r+="\n/*# sourceMappingURL=data:application/json;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(s))))+" */");var i=new Blob([r],{type:"text/css"}),a=e.href;e.href=URL.createObjectURL(i),a&&URL.revokeObjectURL(a)}.bind(null,n,t),s=function(){f(n),n.href&&URL.revokeObjectURL(n.href)}):(n=h(t),r=function(e,t){var n=t.css,r=t.media;r&&e.setAttribute("media",r);if(e.styleSheet)e.styleSheet.cssText=n;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(n))}}.bind(null,n),s=function(){f(n)});return r(e),function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap)return;r(e=t)}else s()}}e.exports=function(e,t){if("undefined"!=typeof DEBUG&&DEBUG&&"object"!=typeof document)throw new Error("The style-loader cannot be used in a non-browser environment");(t=t||{}).attrs="object"==typeof t.attrs?t.attrs:{},t.singleton||"boolean"==typeof t.singleton||(t.singleton=s()),t.insertInto||(t.insertInto="head"),t.insertAt||(t.insertAt="bottom");var n=p(e,t);return u(n,t),function(e){for(var s=[],o=0;o<n.length;o++){var i=n[o];(a=r[i.id]).refs--,s.push(a)}e&&u(p(e,t),t);for(o=0;o<s.length;o++){var a;if(0===(a=s[o]).refs){for(var c=0;c<a.parts.length;c++)a.parts[c]();delete r[a.id]}}}};var v=function(){var e=[];return function(t,n){return e[t]=n,e.filter(Boolean).join("\n")}}();function g(e,t,n,r){var s=n?"":r.css;if(e.styleSheet)e.styleSheet.cssText=v(t,s);else{var o=document.createTextNode(s),i=e.childNodes;i[t]&&e.removeChild(i[t]),i.length?e.insertBefore(o,i[t]):e.appendChild(o)}}},function(e,t,n){"use strict";var r=n(0);t.a={obtainToken:function(e={}){return new Promise((t,n)=>{let s=null,o=null;window.addEventListener("message",function e(i){clearInterval(o),i.origin===r.a.host?(null!==s&&(s.close(),s=null),window.removeEventListener("message",e,!1),t(i.data)):n()},!1);const i=screen.width/2-200,a=screen.height/2-300,c={client_id:r.a.clientId,redirect_uri:r.a.redirectUri,response_type:"token"};e.scopes&&(c.scope=e.scopes.join(" ")),s=window.open(`https://accounts.spotify.com/authorize?${function(e){const t=[];for(const n in e)e.hasOwnProperty(n)&&t.push(`${encodeURIComponent(n)}=${encodeURIComponent(e[n])}`);return t.join("&")}(c)}`,"Spotify",`menubar=no,location=no,resizable=no,scrollbars=no,status=no, width=400, height=600, top=${a}, left=${i}`),o=setInterval(()=>{null!==s&&s.closed&&(clearInterval(o),n({message:"access_denied"}))},1e3)})}}},,function(e,t,n){e.exports=n.p+"favicon.ico"},,function(e,t,n){},function(e,t,n){var r=n(8);"string"==typeof r&&(r=[[e.i,r,""]]);var s={hmr:!0,transform:void 0,insertInto:void 0};n(3)(r,s);r.locals&&(e.exports=r.locals)},function(e,t){e.exports=function(e){var t="undefined"!=typeof window&&window.location;if(!t)throw new Error("fixUrls requires window.location");if(!e||"string"!=typeof e)return e;var n=t.protocol+"//"+t.host,r=n+t.pathname.replace(/\/[^\/]*$/,"/");return e.replace(/url\s*\(((?:[^)(]|\((?:[^)(]+|\([^)(]*\))*\))*)\)/gi,function(e,t){var s,o=t.trim().replace(/^"(.*)"$/,function(e,t){return t}).replace(/^'(.*)'$/,function(e,t){return t});return/^(#|data:|http:\/\/|https:\/\/|file:\/\/\/|\s*$)/i.test(o)?e:(s=0===o.indexOf("//")?o:0===o.indexOf("/")?n+o:r+o.replace(/^\.\//,""),"url("+JSON.stringify(s)+")")})}},,function(e,t,n){},function(e,t,n){var r=n(12);"string"==typeof r&&(r=[[e.i,r,""]]);var s={hmr:!0,transform:void 0,insertInto:void 0};n(3)(r,s);r.locals&&(e.exports=r.locals)},function(e,t,n){"use strict";function r(e){this.requestsPerSecond=e.requestsPerSecond,this.promiseImplementation=e.promiseImplementation||Promise,this.lastStartTime=0,this.queued=[]}r.prototype.add=function(e,t){var n=this,r=t||{};return new n.promiseImplementation(function(t,s){n.queued.push({resolve:t,reject:s,promise:e,weight:r.weight||1,signal:r.signal}),n.dequeue()})},r.prototype.addAll=function(e,t){var n=e.map(function(e){return this.add(e,t)}.bind(this));return Promise.all(n)},r.prototype.dequeue=function(){if(this.queued.length>0){var e=new Date,t=this.queued[0].weight,n=1e3/this.requestsPerSecond*t,r=e-this.lastStartTime;r>=n?this._execute():setTimeout(function(){this.dequeue()}.bind(this),n-r)}},r.prototype._execute=function(){this.lastStartTime=new Date;var e=this.queued.shift();e.signal&&e.signal.aborted?e.reject(new DOMException("","AbortError")):e.promise().then(function(t){e.resolve(t)}).catch(function(t){e.reject(t)})},e.exports=r},function(e,t){var n;n=function(){return this}();try{n=n||Function("return this")()||(0,eval)("this")}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){"use strict";n.r(t),function(e){n(14);var t=n(4),r=n(2),s=n(1);n(13),n(9),n(6);const o=[400,401,404,429,500,502,503,504];const i=new class{needsCheckForDuplicates(e){if("snapshot_id"in e)try{if("0"===localStorage.getItem(e.snapshot_id))return!1}catch(e){return!0}return!0}storePlaylistWithoutDuplicates(e){if("snapshot_id"in e)try{localStorage.setItem(e.snapshot_id,"0")}catch(e){}}},a="https://api.spotify.com/v1";class c{constructor(){this.token=null}setAccessToken(e){this.token=e}async getMe(){return await this.getGeneric(`${a}/me`)}async getGeneric(e,t){const n=void 0===t?"":`?${Object.keys(t).map(e=>`${e}=${t[e]}`).join("&")}`,r=await Object(s.a)(`${e}${n}`,{method:"GET",headers:{Authorization:`Bearer ${this.token}`},retryOn:o}),i=await r.json();return r.ok?i:null}async getUserPlaylists(e,t){const n="string"==typeof e?`${a}/users/${encodeURIComponent(e)}/playlists`:`${a}/me/playlists`;return await this.getGeneric(n,t)}async removeTracksFromPlaylist(t,n,r){const i={tracks:r.map(e=>"string"==typeof e?{uri:e}:e)},c=await Object(s.a)(`${a}/users/${encodeURIComponent(t)}/playlists/${n}/tracks`,{method:"DELETE",headers:{Authorization:`Bearer ${this.token}`},body:JSON.stringify(i),retryOn:o}),l=await c.json();return c.ok?l:(e.Raven&&Raven.captureMessage(`Status ${c.status} when deleting tracks from playlist`,{extra:{json:l}}),null)}async getMySavedTracks(e){return this.getGeneric(`${a}/me/tracks`,e)}async removeFromMySavedTracks(e){return!!(await Object(s.a)(`${a}/me/tracks`,{method:"DELETE",headers:{Authorization:`Bearer ${this.token}`},body:JSON.stringify(e),retryOn:o})).ok}}const l=function(){let n,s,o,a=new Vue({el:"#app",data:{isLoggedIn:!1,toProcess:100,playlists:[],savedTracks:{duplicates:[],status:""}},methods:{removeDuplicates:t=>(async()=>{if("starred"===t.playlist.id&&e.alert("It is not possible to delete duplicates from your Starred playlist using this tool since this is not supported in the Spotify Web API. You will need to remove these manually."),t.playlist.collaborative)e.alert("It is not possible to delete duplicates from a collaborative playlist using this tool since this is not supported in the Spotify Web API. You will need to remove these manually.");else try{await n.removeDuplicates(t);t.duplicates=[],t.status="Duplicates removed",e.ga&&ga("send","event","spotify-dedup","playlist-removed-duplicates")}catch(n){e.Raven&&Raven.captureMessage("Exception trying to remove duplicates from playlist",{extra:{duplicates:t.duplicates}})}})(),removeDuplicatesInSavedTracks:()=>(async()=>{await s.removeDuplicates(a.savedTracks);a.savedTracks.duplicates=[],a.savedTracks.status="Duplicates removed",e.ga&&ga("send","event","spotify-dedup","saved-tracks-removed-duplicates")})()},computed:{duplicates:function(){return this.playlists.reduce((e,t)=>e+t.duplicates.length,0)+this.savedTracks.duplicates.length}}});document.getElementById("login").addEventListener("click",function(){t.a.obtainToken({scopes:["playlist-read-private","playlist-read-collaborative","playlist-modify-public","playlist-modify-private","user-library-read","user-library-modify"]}).then(function(t){!function(t){a.isLoggedIn=!0,(o=new c).setAccessToken(t),n=new r.a(o),s=new r.b(o);let u=0;const p=()=>o.getMe().then(t=>{null===t?(u++,e.Raven&&Raven.captureMessage("Retrying logging user in",{extra:{attempts:u}}),p()):(async()=>{await async function(t){var r=t.id,c=[];const u=await function(e){return async function(e){function t(e,t,n){return o.getGeneric(function(e){var t=new URL(e);return t.origin+t.pathname}(e.href)+"?offset="+t+"&limit="+n)}console.log("promisesForPages!"),console.log(e);const n=await e;if(console.log("got initial request",n),null===n)return[];const r=[()=>e];let s=n.limit+n.offset;const i=n.limit;for(;n.total>s;)!function(e,n,s){r.push(()=>t(e,n,s))}(n,s,i),s+=i;return console.log(r[0]()),r.reduce((e,t)=>e.then(e=>(console.log("executing",t),t().then(Array.prototype.concat.bind(e)))),Promise.resolve([]))}(o.getUserPlaylists(e,{limit:50})).then(function(t){var n=[];return t.forEach(function(t){n=n.concat(t.items.filter(function(t){return t.owner.id===e}))}),n})}(r);c=u,a.playlists=c.map(e=>l(e)),a.toProcess=a.playlists.length+1;const p=await s.getTracks(o.getMySavedTracks({limit:50}));a.savedTracks.duplicates=s.findDuplicatedTracks(p),a.savedTracks.duplicates.length&&e.ga&&ga("send","event","spotify-dedup","saved-tracks-found-duplicates");a.toProcess--,a.playlists.forEach(t=>(async()=>{if(i.needsCheckForDuplicates(t.playlist)){const e=await n.getTracks(t.playlist);t.duplicates=n.findDuplicatedTracks(e),0===t.duplicates.length&&i.storePlaylistWithoutDuplicates(t.playlist)}!function(t){t.processed=!0;var n=a.toProcess-1;a.toProcess-=1,0===n&&e.ga&&ga("send","event","spotify-dedup","library-processed")}(t.playlist)})())}(t)})()});p()}(t)}).catch(function(e){console.error(e)});const l=e=>({playlist:e,duplicates:[],status:"",processed:!1})})};e.Raven&&Raven.config("https://22cbac299caf4962b74de18bc87a8d74@sentry.io/1239123").install(),e.Raven?Raven.context(l):l()}.call(this,n(15))}]);
//# sourceMappingURL=main.e2dc9a4b9d5ba207a77f.js.map